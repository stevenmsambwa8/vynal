<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Dashboard</title>
</head>
<body>
    <div id="app">
        <header>
            <h1>Social Dashboard</h1>
            <div id="user-info">Welcome, User!</div>
        </header>

        <div id="dashboard">
            <!-- Create Post Section -->
            <div id="create-post-section">
                <h2>Create Post</h2>
                <form id="post-form">
                    <textarea id="post-content" placeholder="What's on your mind?" rows="3" cols="50" required></textarea><br><br>
                    <input type="file" id="post-image" accept="image/*"><br><br>
                    <button type="submit">Post</button>
                </form>
            </div>

            <!-- Posts Feed -->
            <div id="posts-container">
                <h2>Posts</h2>
                <div id="posts-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = "https://jcrbwmpapgovyqaxajlb.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjcmJ3bXBhcGdvdnlxYXhhamxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDc2NjAsImV4cCI6MjA3MjYyMzY2MH0.7jMgdHQGWfAsQ9b5C2gn8z7YqFLuA6gR_gIF0VIW56M";

        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Mock user data (replace with your actual user handling)
        const currentUser = {
            id: 'demo-user-id',
            email: 'user@example.com',
            user_metadata: {
                full_name: 'Demo User',
                avatar_url: 'https://via.placeholder.com/40'
            }
        };

        let postsSubscription = null;

        // DOM Elements
        const postForm = document.getElementById('post-form');
        const postsList = document.getElementById('posts-list');

        // Post Functions
        async function createPost(content, imageFile = null) {
            let imageUrl = null;
            
            if (imageFile) {
                const fileName = `${Date.now()}-${imageFile.name}`;
                const { data: uploadData, error: uploadError } = await sb.storage
                    .from('post-images')
                    .upload(fileName, imageFile);
                
                if (uploadError) {
                    console.error('Error uploading image:', uploadError);
                } else {
                    const { data: urlData } = sb.storage
                        .from('post-images')
                        .getPublicUrl(fileName);
                    imageUrl = urlData.publicUrl;
                }
            }

            const { data, error } = await sb
                .from('posts')
                .insert({
                    user_id: currentUser.id,
                    content: content,
                    image_url: imageUrl
                })
                .select();

            if (error) {
                console.error('Error creating post:', error);
            } else {
                document.getElementById('post-content').value = '';
                document.getElementById('post-image').value = '';
                await loadPosts(); // Reload posts after creating
            }
        }

        async function toggleLike(postId, postElement) {
            const likeBtn = postElement.querySelector('.like-btn');
            const likeCount = postElement.querySelector('.like-count');
            const isLiked = likeBtn.classList.contains('liked');
            
            // Fast counter update
            const currentCount = parseInt(likeCount.textContent);
            if (isLiked) {
                likeCount.textContent = currentCount - 1;
                likeBtn.classList.remove('liked');
                likeBtn.textContent = 'â™¡ Like';
            } else {
                likeCount.textContent = currentCount + 1;
                likeBtn.classList.add('liked');
                likeBtn.textContent = 'â™¥ Liked';
            }

            // Database update
            if (isLiked) {
                const { error } = await sb
                    .from('likes')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('post_id', postId);
                if (error) console.error('Error removing like:', error);
            } else {
                const { error } = await sb
                    .from('likes')
                    .insert({
                        user_id: currentUser.id,
                        post_id: postId
                    });
                if (error) console.error('Error adding like:', error);
            }
        }

        async function addComment(postId, content, postElement) {
            const commentsList = postElement.querySelector('.comments-list');
            const commentCount = postElement.querySelector('.comment-count');
            
            // Fast counter update
            const currentCount = parseInt(commentCount.textContent);
            commentCount.textContent = currentCount + 1;
            
            // Add comment to UI immediately
            const tempComment = document.createElement('div');
            tempComment.className = 'comment';
            tempComment.innerHTML = `
                <strong>${currentUser.user_metadata.full_name}:</strong> ${content}
                <small> - just now</small>
            `;
            commentsList.appendChild(tempComment);

            // Database update
            const { data, error } = await sb
                .from('comments')
                .insert({
                    user_id: currentUser.id,
                    post_id: postId,
                    content: content
                })
                .select(`
                    *,
                    profiles:user_id (name, avatar_url)
                `);

            if (error) {
                console.error('Error adding comment:', error);
                // Revert on error
                commentCount.textContent = currentCount;
                commentsList.removeChild(tempComment);
            } else {
                // Replace temp comment with real data
                const profileName = data[0].profiles?.name || currentUser.user_metadata.full_name;
                tempComment.innerHTML = `
                    <strong>${profileName}:</strong> ${data[0].content}
                    <small> - ${new Date(data[0].created_at).toLocaleString()}</small>
                `;
            }
        }

        async function loadPosts() {
            const { data: posts, error } = await sb
                .from('posts')
                .select(`
                    *,
                    profiles:user_id (name, avatar_url),
                    likes (user_id),
                    comments (
                        *,
                        profiles:user_id (name, avatar_url)
                    )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading posts:', error);
                return;
            }

            postsList.innerHTML = '';
            posts.forEach(post => {
                const postElement = createPostElement(post);
                postsList.appendChild(postElement);
            });
        }

        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.setAttribute('data-post-id', post.id);
            
            const userLiked = post.likes.some(like => like.user_id === currentUser.id);
            const authorName = post.profiles?.name || 'Unknown User';
            const authorAvatar = post.profiles?.avatar_url || 'https://via.placeholder.com/40';
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" alt="Avatar" width="40" height="40" style="border-radius: 50%;">
                    <div>
                        <strong>${authorName}</strong>
                        <div><small>${new Date(post.created_at).toLocaleString()}</small></div>
                    </div>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" alt="Post image" style="max-width: 100%; height: auto;">` : ''}
                </div>
                <div class="post-actions">
                    <button class="like-btn ${userLiked ? 'liked' : ''}" onclick="handleLike('${post.id}')">
                        ${userLiked ? 'â™¥ Liked' : 'â™¡ Like'}
                    </button>
                    <span class="like-count">${post.like_count || post.likes.length}</span>
                    <button onclick="toggleComments('${post.id}')">ðŸ’¬ Comment</button>
                    <span class="comment-count">${post.comment_count || post.comments.length}</span>
                </div>
                <div class="comments-section" style="display:none;">
                    <div class="add-comment">
                        <input type="text" placeholder="Add a comment..." class="comment-input">
                        <button onclick="handleAddComment('${post.id}')">Post</button>
                    </div>
                    <div class="comments-list">
                        ${post.comments.map(comment => `
                            <div class="comment">
                                <strong>${comment.profiles?.name || 'Unknown User'}:</strong> ${comment.content}
                                <small> - ${new Date(comment.created_at).toLocaleString()}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <hr>
            `;
            
            return postDiv;
        }

        // Global functions for onclick handlers
        window.handleLike = function(postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            toggleLike(postId, postElement);
        };

        window.toggleComments = function(postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            const commentsSection = postElement.querySelector('.comments-section');
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        };

        window.handleAddComment = function(postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            const commentInput = postElement.querySelector('.comment-input');
            const content = commentInput.value.trim();
            
            if (content) {
                addComment(postId, content, postElement);
                commentInput.value = '';
            }
        };

        // Real-time subscriptions
        function setupRealtimeSubscriptions() {
            postsSubscription = sb
                .channel('posts-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'posts' },
                    (payload) => {
                        console.log('Posts change:', payload);
                        loadPosts(); // Reload posts on any change
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'likes' },
                    (payload) => {
                        console.log('Likes change:', payload);
                        updatePostCounts(payload.new?.post_id || payload.old?.post_id);
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'comments' },
                    (payload) => {
                        console.log('Comments change:', payload);
                        if (payload.eventType === 'INSERT') {
                            loadCommentsForPost(payload.new.post_id);
                        }
                    }
                )
                .subscribe();
        }

        async function updatePostCounts(postId) {
            const { data, error } = await sb
                .from('posts')
                .select('like_count, comment_count')
                .eq('id', postId)
                .single();
            
            if (!error && data) {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    postElement.querySelector('.like-count').textContent = data.like_count;
                    postElement.querySelector('.comment-count').textContent = data.comment_count;
                }
            }
        }

        async function loadCommentsForPost(postId) {
            const { data: comments, error } = await sb
                .from('comments')
                .select(`
                    *,
                    profiles:user_id (name, avatar_url)
                `)
                .eq('post_id', postId)
                .order('created_at', { ascending: true });

            if (!error && comments) {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    const commentsList = postElement.querySelector('.comments-list');
                    commentsList.innerHTML = comments.map(comment => `
                        <div class="comment">
                            <strong>${comment.profiles?.name || 'Unknown User'}:</strong> ${comment.content}
                            <small> - ${new Date(comment.created_at).toLocaleString()}</small>
                        </div>
                    `).join('');
                }
            }
        }

        // Event Listeners
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('post-content').value;
            const imageFile = document.getElementById('post-image').files[0];
            
            if (content.trim()) {
                await createPost(content, imageFile);
            }
        });

        // Initialize the dashboard
        async function initializeDashboard() {
            await loadPosts();
            setupRealtimeSubscriptions();
        }

        // Start the app
        initializeDashboard();
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .post {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .post-header img {
            border: 2px solid #ddd;
        }
        
        .post-content {
            margin-bottom: 15px;
        }
        
        .post-content p {
            margin: 0 0 10px 0;
            line-height: 1.5;
        }
        
        .post-content img {
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .post-actions {
            margin: 15px 0;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .post-actions button {
            margin-right: 15px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .post-actions button:hover {
            background: #f8f9fa;
        }
        
        .like-btn.liked {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        
        .like-count, .comment-count {
            margin-right: 15px;
            color: #666;
            font-weight: bold;
        }
        
        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .add-comment {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .add-comment input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-comment button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-comment button:hover {
            background: #0056b3;
        }
        
        .comment {
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        
        .comment small {
            color: #666;
        }
        
        #create-post-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #create-post-section h2 {
            margin-top: 0;
            color: #333;
        }
        
        #post-content {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        
        #post-image {
            margin: 10px 0;
        }
        
        #post-form button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #post-form button:hover {
            background: #218838;
        }
        
        #posts-container h2 {
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</body>
</html>
