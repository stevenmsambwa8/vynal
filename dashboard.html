<!DOCTYPE html>
<html>
<head>
  <title>Supabase Interactive App</title>
</head>
<body>
  <h1>Welcome to Supabase Interactive Zone</h1>

  <div id="user-info"></div>

  <button id="login-btn">Login with Google</button>
  <button id="logout-btn">Logout</button>

  <h2>Signed-in Users</h2>
  <ul id="user-list"></ul>

  <h2>Post a Message</h2>
  <textarea id="message-input" placeholder="Type your message here..."></textarea><br/>
  <button id="send-message-btn">Send</button>

  <h2>Live Messages</h2>
  <ul id="messages-list"></ul>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://jcrbwmpapgovyqaxajlb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjcmJ3bXBhcGdvdnlxYXhhamxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDc2NjAsImV4cCI6MjA3MjYyMzY2MH0.7jMgdHQGWfAsQ9b5C2gn8z7YqFLuA6gR_gIF0VIW56M";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userInfo = document.getElementById("user-info");
    const userList = document.getElementById("user-list");
    const messageInput = document.getElementById("message-input");
    const sendMessageBtn = document.getElementById("send-message-btn");
    const messagesList = document.getElementById("messages-list");

    // Login with Google
    loginBtn.onclick = async () => {
      await sb.auth.signInWithOAuth({ provider: 'google' });
    };

    // Logout
    logoutBtn.onclick = async () => {
      await sb.auth.signOut();
    };

    // Listen to auth changes
    sb.auth.onAuthStateChange(async (event, session) => {
      const user = session?.user;
      if (user) {
        userInfo.textContent = `Signed in as ${user.email}`;
        await upsertUser(user);
        fetchUsers();
        fetchMessages();
        listenForMessages();
      } else {
        userInfo.textContent = 'Not signed in.';
        userList.innerHTML = '';
        messagesList.innerHTML = '';
      }
    });

    // Upsert user on login
    async function upsertUser(user) {
      const { data, error } = await sb.from('users').upsert({
        id: user.id,
        email: user.email,
        full_name: user.user_metadata.full_name,
        avatar_url: user.user_metadata.avatar_url,
        last_login: new Date().toISOString()
      });
    }

    // Fetch all users
    async function fetchUsers() {
      const { data: users } = await sb.from('users').select('*').order('last_login', { ascending: false });
      userList.innerHTML = '';
      users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = `${u.full_name || u.email}`;
        userList.appendChild(li);
      });
    }

    // Send a message
    sendMessageBtn.onclick = async () => {
      const session = await sb.auth.getSession();
      const user = session.data.session?.user;
      if (!user) return;

      const content = messageInput.value;
      if (!content) return;

      await sb.from('messages').insert({
        user_id: user.id,
        content: content
      });

      messageInput.value = '';
    };

    // Fetch existing messages
    async function fetchMessages() {
      const { data: messages } = await sb
        .from('messages')
        .select('content, created_at, users(full_name)')
        .order('created_at', { ascending: false })
        .limit(20);

      messagesList.innerHTML = '';
      messages.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = `${msg.users?.full_name || "Unknown"}: ${msg.content} (${msg.created_at})`;
        messagesList.appendChild(li);
      });
    }

    // Listen for new messages in real-time
    function listenForMessages() {
      sb.channel('realtime:messages')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages' },
          payload => {
            const msg = payload.new;
            const li = document.createElement('li');
            li.textContent = `New message: ${msg.content}`;
            messagesList.prepend(li);
          }
        )
        .subscribe();
    }

  </script>
</body>
</html>
