<!DOCTYPE html>  
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VYNAL â€¢ Artist Dashboard</title>
<link rel="stylesheet" href="remixicon.min.css">
<link rel="stylesheet" href="app.css">

<style>
/* === Post UI Enhancements === */
.post-card { cursor: pointer; }

/* Post image fixed height + cover */
.post-media {
  position: relative;
}


/* Watermark overlay */
.post-media .watermark {
  position: absolute;
  bottom: 8px;
  right: 8px;
  opacity: 0.8;
  pointer-events: none;
}

.post-media .watermark img {
  height: 50px;
  border-radius: 999px;
  width: auto;
}

.hidden { display: none !important; }


@keyframes fadeIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}



@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.4); }
  100% { transform: scale(1); }
}
</style>
</head>

<body>

<!-- ===== Sidebar ===== -->
<aside class="aside" aria-label="Sidebar">
<div class="brand"><span><img src="oflogo2.png" width="300"> </span></div>
<div class="side-search">
<i class="ri-search-2-line" aria-hidden="true"></i>
<input type="search" placeholder="Quick jumpâ€¦" aria-label="Sidebar quick jump" />
</div>


<div class="side-group">
<div class="side-label">Main</div>
<nav class="nav" aria-label="Primary">
<a href="start.html" class="active"><i class="ri-stack-fill"></i><span>Feed</span></a>
<a href="upload.html"><i class="ri-upload-cloud-2-line"></i><span>Upload</span></a>
<a href="mall.html"><i class="ri-music-line"></i><span>Mi-pages</span></a>
<a href="states.html"><i class="ri-dashboard-line"></i><span>Dashboard</span></a>
<a href="index.html"><i class="ri-book-line"></i><span>Documents</span></a>
</nav>
</div>

<div class="side-group">
<div class="side-label" id="userInfo">Account</div>
<nav class="nav" aria-label="Secondary">
<a href="#" data-link><i class="ri-user-3-line"></i><span id="user-name">Profile</span></a>
<a href="#" data-link><i class="ri-settings-3-line"></i><span id="user-email">Settings</span></a>
</nav>
</div>

<div class="collapse">
<button class="btn-icon" id="logout-btn" title="Toggle me" aria-label="Toggle theme"><i
class="ri-sun-line"></i></button>
</div>
</aside>

<section id="content">
<!-- ===== Header ===== -->
<header class="header" role="banner">
<div class="moblogo"><span><img src="ofminilogo1.png" height="40"> </span></div>
<div class="searchbar">
<i class="ri-search-2-line" aria-hidden="true"></i>
<input type="search" id="searchAll" placeholder="Search tracks, posts, connectedâ€¦"
aria-label="Global search" />
</div>
<div class="actions">
<button class="pill upload-btn"><i class="ri-add-line"></i><span>Create</span></button>
<button class="btn-icon" id="btnNoti" aria-label="Notifications"><i class="ri-notification-3-line"></i></button>
<a href="mall.html" data-link><button class="btn-icon" aria-label="Notifications"><i class="ri-shopping-bag-line"></i></button></a>
<img class="avatar user-avatar" role="button" tabindex="0" aria-haspopup="menu" aria-expanded="false">
</div>

</header>
<!-- ===== Main ===== -->
<main class="main">
 <!-- Loading/Status Messages -->
    <div id="statusMessage" style="display:none; padding: 20px; background: #e3f2fd; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <span id="statusText">Loading posts...</span>
    </div>
<!-- === Post templates === -->
<section class="grid-12" id="postsContainer">
 
  <!-- === Admini === -->
<div class="span-4" data-animate>
<div class="post-card" data-animate style="box-shadow: none;">
  <div class="post-header">
  <div class="post-header-left">
    <div class="post-header-info">
  <strong>
    Admini Sponsored Post
  </strong>
  <div class="muted">example time stamp - 2 minutes ago</div>
</div>

  </div>
  <div class="post-header-right">
    <button class="menu-btn"><i class="ri-add-line"></i></button>
  </div>
</div>

  <div class="post-body">
    Example admini content or description<span class="hashtag">#example tags</span>
  </div>

  <div class="post-media">
    <img src="ofminilogo1.png" alt="Post media" width="100%">
    <div class="watermark"><img src="cod.jpg" alt="logo"></div>
  </div>
<div class="post-actions">
    <button class="action-btn"><i class="ri-blaze-fill"></i><span>23M</span></button>
    <button class="action-btn"><i class="ri-link"></i><span>2.4k</span></button>
    <button class="action-btn"><i class="ri-add-line"></i>Posts<span>2.4k </span></button>    
</div>
 
</div>
</div>

</section>

 <div class="divider"></div>



  <!-- Comments -->
   <div class="modal-backdrop hidden" id="CommentModal">
  <div class="modal" style="width: 90%;max-width: 500px;">
  
<div class="comments-header">
  <strong>Comments</strong>
  <button class="btn-icon" id="commentClose"><i class="ri-close-line"></i></button>
</div>

<div class="comments comments-list">
  <!-- Comment-->
  <template id="commentTemplate" class="comment">
    <div class="comment-avatar">
      <img class="comment-avatar" src="" alt="avatar">
    </div>
    <div class="comment-body comment-content">
      <div class="comment-header">
        <span class="comment-author">@example</span>
        <div class="comment-like">
          <button class="delete-comment" onclick="deleteComment(this)" style="display:none"><i class="ri-telegram-line"></i></button>
        </div>
      </div>
      <div class="comment-text">example comment ðŸ”¥</div>
      <div class="comment-footer">
        <span>Reply</span>
        <span>Report</span>
        <span class="comment-time">2m ago</span>
      </div>
    </div>
  </template>

  <!-- Add Comment Inline -->
  <div class="add-comment-wrapper comment-form" onsubmit="addComment(event, this)">
    <textarea class="add-comment" rows="1" placeholder="Add a commentâ€¦"></textarea>
    <button class="post-comment">Post</button>
  </div>
</div>


</div>
</div>


<template id="postTemplate">
<div class="span-4">
<div class="post-card post" data-post-id="" style="box-shadow: none;">
<div class="post-media">
    <img class="post-image" src="" alt="Post Image" style="display:none" width="100%">
      <div class="watermark"><img class="user-avatar" src="" alt="logo"></div>
  </div>
  <audio class="post-music" controls style="display:none">
                    <source src="" type="audio/mpeg">
                </audio>
  <div class="post-header">
  <div class="post-header-left">
  <div class="post-header-info">
  <strong class="user-name">
    Username
  </strong>
  <div class="muted post-time"><span style="font-weight: 600;"> Timestamp eg (2 min ago)</span></div>
</div>

  </div>
  <div class="post-header-right">
    <button class="btn ghost" style="color: var(--brand);"><i class="ri-external-link-line"></i></button>
    <button class="btn ghost delete-post" onclick="deletePost(this)" style="display:none">Delete</button>
  </div>
</div>

  <div class="post-body post-title">
    Example admini content or description
  </div>
  <!--<div class="post-body post-description hashtag">
    Example admini content or description
  </div>-->
  <div class="post-actions">
    <button class="action-btn like-btn" onclick="toggleLike(this)"><i class="ri-heart-line" style="color: var(--brand-2);"></i><span class="likes-count"></span></button>
    <button class="action-btn comment-btn"><i class="ri-chat-3-line"></i><span class="comments-count"></span></button>
    <button class="action-btn share-btn"><i class="ri-share-forward-line"></i><span>12.8K</span></button>
    <button class="action-btn"><i class="ri-bookmark-line"></i><span>30B</span></button>
  </div>
</div>
</div>
</template>


<!-- Share Modal -->
<div class="modal-backdrop hidden" id="shareModal">
  <div class="modal" role="document">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <strong>Share Post</strong>
      <button class="btn-icon" id="shareClose"><i class="ri-close-line"></i></button>
    </div>
    <div class="divider"></div>
    <div style="display:grid; gap:10px; margin-top:10px;">
      <button class="btn ghost"><i class="ri-link"></i> Copy Link</button>
      <button class="btn ghost"><i class="ri-twitter-line"></i> Share to Twitter</button>
      <button class="btn ghost"><i class="ri-facebook-circle-line"></i> Share to Facebook</button>
      <button class="btn ghost"><i class="ri-telegram-line"></i> Share to Telegram</button>
    </div>
  </div>
</div>

</main>

<div class="modal-backdrop hidden" id="uploadModal">
  <div class="modal" role="document" style="width: 400px;" id="createPostSection">
        <h3>What to tease for today?</h3>
        <form  id="createPostForm" class="upload" novalidate>
          <div class="row">
            <div class="col-8"><input class="input" type="text" id="postTitle" placeholder="Description area *" required></div>
          </div>
          <div class="row">
            <div class="col-8"><input class="input" type="text" id="postDescription" placeholder="decrt"></div>
            <div class="col-4"><input class="input" type="file" id="postImage"  accept="image/*" aria-label="Cover image"></div>
           
            <input type="file" id="postMusic" accept="audio/*">
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn ghost" title="Why cancel?" style="background-color: #c5040433;" id="uploadClose"><i class="ri-close-line"></i> Cancel</button>
            <button class="btn primary" id="uSubmit" title="Let's get popular" type="submit"><i class="ri-upload-2-line"></i> Upload</button>
          </div>
        </form>
  </div>
</div>

 
<div class="space"></div>
</section>

<!-- ===== Bottom Nav (mobile only) ===== -->
<nav class="bottom-nav" aria-label="Mobile navigation">
  <a href="dashboard.html" class="active"><i class="ri-stack-fill"></i></a>
  <a href="upload.html"><i class="ri-upload-cloud-2-line"></i> Upload</a>
  <a href="mall.html"><i class="ri-shopping-bag-2-line"></i>Mi-mall</a>
  <a href="statehome.html"><i class="ri-compass-2-line"></i>States</a>
  <a href="mall.html"><i class="ri-user-4-line"></i>Account</a>
</nav>

<script src="app.js"></script>

<script>
  function toggleReplies(el) {
  const replies = el.nextElementSibling;
  if (replies.style.display === "block") {
    replies.style.display = "none";
    el.textContent = el.dataset.original || "View replies";
  } else {
    replies.style.display = "block";
    if (!el.dataset.original) el.dataset.original = el.textContent;
    el.textContent = "Hide replies";
  }
}
</script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://jcrbwmpapgovyqaxajlb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjcmJ3bXBhcGdvdnlxYXhhamxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDc2NjAsImV4cCI6MjA3MjYyMzY2MH0.7jMgdHQGWfAsQ9b5C2gn8z7YqFLuA6gR_gIF0VIW56M";

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let postIntervals = new Map();

// -------------------- GLOBAL ERROR HANDLER --------------------
window.onerror = (msg, src, line, col, err) => {
    console.error("Global error caught:", msg, err);
    showStatus("An unexpected error occurred. Please refresh.", "error", 5000);
    return true;
};

// -------------------- INIT --------------------
async function initializeApp() {
    try {
        showStatus("Checking authentication...", "loading");

        const { data: { session }, error: sessionError } = await sb.auth.getSession();
        
        if (sessionError) {
            console.error("Session error:", sessionError);
            showStatus("Authentication error: " + sessionError.message, "error");
            return;
        }

        if (!session) {
            showStatus("Not authenticated, redirecting...", "error");
            setTimeout(() => window.location.href = "register.html", 1000);
            return;
        }

        currentUser = session.user;
        console.log("Current user:", currentUser);
        showStatus("Authentication successful!", "success");

        await ensureUserExists();
        displayUserInfo();
        await loadPosts();
        setupRealTimeSubscriptions();
    } catch (error) {
        console.error("Initialization error:", error);
        showStatus("Failed to initialize app: " + error.message, "error", 5000);
    }
}

// -------------------- USER --------------------
async function ensureUserExists() {
    try {
        const { data: existingUser, error } = await sb
            .from("users")
            .select("id")
            .eq("id", currentUser.id)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 is "not found" error
            console.error("Error checking user:", error);
            throw error;
        }

        if (!existingUser) {
            showStatus("Setting up your profile...", "loading");
            const { error: insertError } = await sb.from("users").insert({
                id: currentUser.id,
                email: currentUser.email,
                name: currentUser.user_metadata?.name || currentUser.email,
                avatar_url: currentUser.user_metadata?.avatar_url
            });

            if (insertError) {
                console.error("Error creating user:", insertError);
                throw insertError;
            }
        }
    } catch (error) {
        console.error("Error in ensureUserExists:", error);
        showStatus("Error setting up user profile: " + error.message, "error", 5000);
    }
}

function displayUserInfo() {
    const userInfo = document.getElementById("userInfo");
    if (userInfo) {
        userInfo.innerHTML = `Welcome, ${currentUser.user_metadata?.name || currentUser.email}`;
    }
}

// -------------------- STATUS --------------------
function showStatus(message, type = "loading", duration = null) {
    const statusEl = document.getElementById("statusMessage");
    const statusText = document.getElementById("statusText");

    if (!statusEl || !statusText) {
        console.warn("Status elements not found in DOM");
        console.log("Status:", message, type);
        return;
    }

    statusText.textContent = message;
    statusEl.style.display = "block";

    switch (type) {
        case "success":
            statusEl.style.background = "#e8f5e8";
            statusEl.style.color = "#2e7d2e";
            break;
        case "error":
            statusEl.style.background = "#fee";
            statusEl.style.color = "#d63384";
            break;
        case "info":
            statusEl.style.background = "#e3f2fd";
            statusEl.style.color = "#1976d2";
            break;
        default: // loading
            statusEl.style.background = "#fff3cd";
            statusEl.style.color = "#856404";
    }

    if (duration) {
        setTimeout(() => hideStatus(), duration);
    }
}

function hideStatus() {
    const statusEl = document.getElementById("statusMessage");
    if (statusEl) {
        statusEl.style.display = "none";
    }
}

// -------------------- POSTS --------------------
async function loadPosts() {
    showStatus("Loading posts...", "loading");
    console.log("Starting to load posts...");

    try {
        // First, try a simple query to test connection
        const { data: testData, error: testError } = await sb
            .from("posts")
            .select("id")
            .limit(1);

        console.log("Test query result:", { testData, testError });

        if (testError) {
            console.error("Test query failed:", testError);
            showStatus("Database connection error: " + testError.message, "error", 5000);
            return;
        }

        // Now try the full query
        const { data: posts, error } = await sb
            .from("posts")
            .select(`
                *,
                users!posts_user_id_fkey (
                    name, 
                    avatar_url
                )
            `)
            .order("created_at", { ascending: false });

        console.log("Posts query result:", { posts, error });

        const container = document.getElementById("postsContainer");
        if (!container) {
            console.error("Posts container not found in DOM");
            showStatus("Posts container not found", "error", 5000);
            return;
        }

        container.innerHTML = "";

        if (error) {
            console.error("Error loading posts:", error);
            showStatus("Error loading posts: " + error.message, "error", 5000);
            return;
        }

        if (!posts || posts.length === 0) {
            showStatus("No posts found. Be the first to create one!", "info", 3000);
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No posts yet. Create the first one!</div>';
            return;
        }

        console.log(`Rendering ${posts.length} posts...`);
        posts.forEach((post, index) => {
            try {
                console.log(`Rendering post ${index + 1}:`, post);
                appendPost(post);
            } catch (err) {
                console.error("Error rendering post:", post, err);
            }
        });

        showStatus(`Successfully loaded ${posts.length} posts!`, "success", 2000);

    } catch (err) {
        console.error("Unexpected error loading posts:", err);
        showStatus("Unexpected error occurred while loading posts: " + err.message, "error", 5000);
    }
}

function createPostElement(post) {
    const template = document.getElementById("postTemplate");
    if (!template) {
        console.error("Post template not found");
        throw new Error("Post template not found");
    }

    const postElement = template.content.cloneNode(true);

    const article = postElement.querySelector(".post");
    if (!article) {
        console.error("Post article element not found in template");
        throw new Error("Post article element not found in template");
    }

    article.setAttribute("data-post-id", post.id || "unknown");

    // Safe user info
    const user = post.users || {};
    
    // Use optional chaining and provide fallbacks
    const userAvatar = postElement.querySelector(".user-avatar");
    const userName = postElement.querySelector(".user-name");
    const postTime = postElement.querySelector(".post-time");
    const postTitle = postElement.querySelector(".post-title");
    const postDescription = postElement.querySelector(".post-description");

    if (userAvatar) userAvatar.src = user.avatar_url || "default-avatar.png";
    if (userName) userName.textContent = user.name || "Unknown User";
    if (postTime) postTime.textContent = post.created_at
        ? new Date(post.created_at).toLocaleString()
        : "Unknown time";

    // Content
    if (postTitle) postTitle.textContent = post.title || "(No title)";
    if (postDescription) postDescription.textContent = post.description || "";

    const img = postElement.querySelector(".post-image");
    if (img) {
        if (post.image_url) {
            img.src = post.image_url;
            img.style.display = "block";
        } else {
            img.style.display = "none";
        }
    }

    const audio = postElement.querySelector(".post-music");
    if (audio) {
        const source = audio.querySelector("source");
        if (post.music_url && source) {
            source.src = post.music_url;
            audio.style.display = "block";
        } else {
            audio.style.display = "none";
        }
    }

    // Stats
    const likesCount = postElement.querySelector(".likes-count");
    const commentsCount = postElement.querySelector(".comments-count");
    
    if (likesCount) likesCount.textContent = post.likes_count ?? 0;
    if (commentsCount) commentsCount.textContent = post.comments_count ?? 0;

    const deleteBtn = postElement.querySelector(".delete-post");
    if (deleteBtn && post.user_id === currentUser?.id) {
        deleteBtn.style.display = "inline-block";
    }

    return postElement;
}

function appendPost(post) {
    const container = document.getElementById("postsContainer");
    if (!container) {
        console.error("Posts container not found");
        return;
    }

    try {
        const postElement = createPostElement(post);
        container.appendChild(postElement);
        startPostUpdates(post.id);
    } catch (error) {
        console.error("Error appending post:", error);
    }
}

function prependPost(post) {
    const container = document.getElementById("postsContainer");
    if (!container) {
        console.error("Posts container not found");
        return;
    }

    try {
        const postElement = createPostElement(post);
        container.insertBefore(postElement, container.firstChild);
        startPostUpdates(post.id);
    } catch (error) {
        console.error("Error prepending post:", error);
    }
}

function startPostUpdates(postId) {
    if (!postId) return;
    
    const interval = setInterval(async () => {
        await updatePostStats(postId);
    }, 5000);
    postIntervals.set(postId, interval);
}

async function updatePostStats(postId) {
    try {
        const { data: post, error } = await sb
            .from("posts")
            .select("likes_count, comments_count")
            .eq("id", postId)
            .single();

        if (!error && post) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            if (postElement) {
                const likesCount = postElement.querySelector(".likes-count");
                const commentsCount = postElement.querySelector(".comments-count");
                
                if (likesCount) likesCount.textContent = post.likes_count ?? 0;
                if (commentsCount) commentsCount.textContent = post.comments_count ?? 0;
            }
        }
    } catch (error) {
        console.error("Error updating post stats:", error);
    }
}

// -------------------- COMMENTS --------------------
async function loadComments(postId) {
    const post = document.querySelector(`[data-post-id="${postId}"]`);
    if (!post) return;

    const commentsList = post.querySelector(".comments-list");
    if (!commentsList) return;

    commentsList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">Loading comments...</div>';

    try {
        const { data: comments, error } = await sb
            .from("comments")
            .select(`
                *,
                users!comments_user_id_fkey (
                    name, 
                    avatar_url
                )
            `)
            .eq("post_id", postId)
            .order("created_at", { ascending: true });

        commentsList.innerHTML = "";

        if (error) {
            console.error("Error loading comments:", error);
            commentsList.innerHTML = '<div style="padding: 10px; color: #dc3545;">Error loading comments</div>';
            return;
        }

        if (!comments || comments.length === 0) {
            commentsList.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">No comments yet. Be the first!</div>';
            return;
        }

        comments.forEach(comment => {
            try {
                appendComment(commentsList, comment);
            } catch (err) {
                console.error("Error rendering comment:", comment, err);
            }
        });

    } catch (err) {
        console.error("Unexpected error loading comments:", err);
        commentsList.innerHTML = '<div style="padding: 10px; color: #dc3545;">Error loading comments</div>';
    }
}

function appendComment(container, comment) {
    const template = document.getElementById("commentTemplate");
    if (!template || !container) return;

    try {
        const commentElement = template.content.cloneNode(true);

        const commentDiv = commentElement.querySelector(".comment");
        if (commentDiv) {
            commentDiv.setAttribute("data-comment-id", comment.id || "unknown");
        }

        const user = comment.users || {};
        
        const avatar = commentElement.querySelector(".comment-avatar");
        const author = commentElement.querySelector(".comment-author");
        const text = commentElement.querySelector(".comment-text");
        const time = commentElement.querySelector(".comment-time");

        if (avatar) avatar.src = user.avatar_url || "default-avatar.png";
        if (author) author.textContent = user.name || "Anonymous";
        if (text) text.textContent = comment.content || "";
        if (time) time.textContent = comment.created_at
            ? new Date(comment.created_at).toLocaleString()
            : "Unknown time";

        const deleteBtn = commentElement.querySelector(".delete-comment");
        if (deleteBtn && comment.user_id === currentUser?.id) {
            deleteBtn.style.display = "inline-block";
        }

        container.appendChild(commentElement);
    } catch (error) {
        console.error("Error appending comment:", error);
    }
}

// -------------------- REALTIME --------------------
function setupRealTimeSubscriptions() {
    try {
        sb.channel("posts")
            .on("postgres_changes", { event: "INSERT", schema: "public", table: "posts" },
                async (payload) => {
                    console.log("New post received:", payload);
                    if (payload.new.user_id !== currentUser?.id) {
                        const { data: post } = await sb
                            .from("posts")
                            .select(`
                                *,
                                users!posts_user_id_fkey (
                                    name, 
                                    avatar_url
                                )
                            `)
                            .eq("id", payload.new.id)
                            .single();

                        if (post) prependPost(post);
                    }
                })
            .subscribe((status) => {
                console.log("Realtime subscription status:", status);
            });
    } catch (error) {
        console.error("Error setting up realtime subscriptions:", error);
    }
}

// -------------------- EVENTS --------------------
// Use DOMContentLoaded instead of load for faster initialization
document.addEventListener("DOMContentLoaded", initializeApp);

window.addEventListener("beforeunload", () => {
    postIntervals.forEach(interval => clearInterval(interval));
});

// Expose functions to global scope if needed for HTML event handlers
window.loadComments = loadComments;
</script>


</body>
</html>
