<!-- File: public/dashboard.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VYNAL â€¢ Artist Dashboard</title>
<link rel="stylesheet" href="remixicon.min.css">
<link rel="stylesheet" href="app.css">
<style>
/* small set of styles used by script */
.post-count { font-weight: 600; margin-left: 6px; }
.like-btn.liked i { color: #ff5a7a; transform: scale(1.05); }
.modal-backdrop { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:40; }
.modal { background:#fff; border-radius:8px; padding:12px; max-height:80vh; overflow:auto; box-shadow:0 12px 40px rgba(0,0,0,0.2); }
.hidden { display:none !important; }
.post-card { margin-bottom:14px; border-radius:8px; background:var(--card-bg, #fff); padding:12px; }
.action-btn { background:none; border:none; cursor:pointer; padding:6px 8px; display:inline-flex; align-items:center; gap:6px; }
.muted { color:#777; font-size:0.9rem; }
.comment { display:flex; gap:8px; margin-bottom:10px; }
.comment-avatar img { width:36px; height:36px; border-radius:999px; object-fit:cover; }
.comment-body { flex:1; background:#f7f7f7; padding:8px; border-radius:8px; }
.add-comment { width:100%; padding:8px; border-radius:8px; }
.small { font-size:0.85rem; color:#555; }
.toast { position:fixed; right:12px; bottom:12px; background:#222;color:#fff;padding:8px 12px;border-radius:8px; z-index:60; }
</style>
</head>
<body>
<aside class="aside" aria-label="Sidebar"> <!-- your sidebar markup (truncated for brevity) -->
  <div style="padding:12px;">
    <img src="oflogo2.png" width="220" alt="Vynal">
    <div id="auth-area" style="margin-top:12px;"></div>
  </div>
</aside>

<section id="content" style="margin-left:260px; padding:20px;">
  <header class="header" style="display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="moblogo"><img src="ofminilogo1.png" height="40"></div>
      <input id="searchAll" placeholder="Search tracks, posts..." style="padding:8px;border-radius:8px;border:1px solid #ddd;" />
    </div>
    <div>
      <button id="btnOpenUpload" class="btn primary">New Post</button>
      <img id="user-pic" class="avatar" src="" style="width:40px;height:40px;border-radius:999px;display:inline-block;margin-left:10px;" alt="">
    </div>
  </header>

  <main class="main" id="main">
    <section id="posts" style="max-width:980px;">
      <!-- Posts will be rendered here -->
    </section>
    <div id="loader" style="color:#666;margin-top:18px;">Loading...</div>
  </main>
</section>

<!-- Comments Modal -->
<div id="commentModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" style="width:90%; max-width:720px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>Comments</strong>
      <div>
        <button id="closeComments">Close</button>
      </div>
    </div>
    <div id="commentsContent" style="margin-top:12px;"></div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <textarea id="newCommentText" rows="2" class="add-comment" placeholder="Add a comment..."></textarea>
      <button id="postCommentBtn" class="btn primary">Post</button>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" style="width:420px;">
    <h3>New Post</h3>
    <div style="display:grid; gap:8px;">
      <textarea id="uContent" rows="4" class="input" placeholder="Write a description..."></textarea>
      <input id="uFile" type="file" accept="image/*,video/*" />
      <div class="progress" id="uProgress" style="height:8px;background:#eee;border-radius:8px;overflow:hidden;">
        <div id="uProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#6ee7b7,#60a5fa)"></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button id="uploadClose" class="btn ghost">Cancel</button>
        <button id="uSubmit" class="btn primary">Upload</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://jcrbwmpapgovyqaxajlb.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_KEY";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* === Post Upload === */
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const desc = document.getElementById("uTitle").value;
  const tags = document.getElementById("uTags").value.split(",").map(t => t.trim());
  const file = document.getElementById("uCover").files[0];

  let mediaUrl = null;
  if (file) {
    const { data, error } = await sb.storage.from("post_media").upload(`posts/${Date.now()}-${file.name}`, file, { upsert: true });
    if (!error) mediaUrl = sb.storage.from("post_media").getPublicUrl(data.path).data.publicUrl;
  }

  await sb.from("posts").insert({ content: desc, tags, media_url: mediaUrl, user_id: (await sb.auth.getUser()).data.user.id });
});

/* === Like Button Optimistic === */
document.addEventListener("click", async (e) => {
  if (e.target.closest(".like-btn")) {
    const btn = e.target.closest(".like-btn");
    const span = btn.querySelector("span");
    span.textContent = parseInt(span.textContent) + 1; // fast bump

    const postId = btn.dataset.postId;
    const userId = (await sb.auth.getUser()).data.user.id;
    await sb.from("likes").insert({ post_id: postId, user_id: userId }).catch(async () => {
      // if already liked, remove
      await sb.from("likes").delete().eq("post_id", postId).eq("user_id", userId);
      span.textContent = parseInt(span.textContent) - 2; // rollback (bump -1 net)
    });
  }
});

/* === Comment Optimistic === */
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("post-comment")) {
    const textarea = e.target.previousElementSibling;
    const content = textarea.value;
    if (!content) return;

    const postId = e.target.dataset.postId;
    const userId = (await sb.auth.getUser()).data.user.id;

    // Optimistic add
    const commentsEl = document.querySelector(".comments");
    commentsEl.innerHTML += `<div class="comment"><div class="comment-body"><strong>You</strong> ${content}</div></div>`;
    textarea.value = "";

    await sb.from("comments").insert({ post_id: postId, user_id: userId, content });
  }
});

/* === Realtime sync === */
sb.channel("db-changes")
  .on("postgres_changes", { event: "*", schema: "public", table: "comments" }, (payload) => {
    // Only update affected post comments
    console.log("New comment event", payload);
  })
  .on("postgres_changes", { event: "*", schema: "public", table: "likes" }, (payload) => {
    // Update like counts for that post only
    console.log("Like event", payload);
  })
  .subscribe();
</script>

</body>
</html>

